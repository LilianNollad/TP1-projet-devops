name: CD - Build & Deploy to Cloud Run

on:
  push:
    tags:
      - 'v*.*.*'  # D√©clenchement sur les tags version (ex: v1.0.0)

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DB_INSTANCE_NAME: ${{ secrets.DB_INSTANCE_NAME }}
  DB_CONNECTION_NAME: ${{ secrets.DB_CONNECTION_NAME }}

jobs:
  build-and-deploy:
    name: Build, Push & Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. R√©cup√©ration du code source
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Extraction de la version depuis le tag Git
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      # 3. Connexion √† Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Build et push de l'image CRUD API
      - name: Build and push CRUD API image
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "üèóÔ∏è  Building CRUD API image..."

          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/crud-app:$VERSION \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/crud-app:latest \
            -f Dockerfile \
            .

          echo "üì§ Pushing CRUD API image..."
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/crud-app:$VERSION
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/crud-app:latest

          echo "‚úÖ CRUD API image pushed successfully"

      # 5. Build et push de l'image Fluent Bit
      - name: Build and push Fluent Bit image
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "üèóÔ∏è  Building Fluent Bit image..."

          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/crud-fluent-bit:$VERSION \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/crud-fluent-bit:latest \
            -f Dockerfile.fluent-bit \
            .

          echo "üì§ Pushing Fluent Bit image..."
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/crud-fluent-bit:$VERSION
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/crud-fluent-bit:latest

          echo "‚úÖ Fluent Bit image pushed successfully"

      # 6. Authentification avec Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 7. Configuration du SDK Google Cloud
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 8. Authentification avec Artifact Registry / GCR (optionnel)
      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker

      # 9. Build de l'image de migration
      - name: Build migration image
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "üèóÔ∏è  Building migration image..."

          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/crud-migration:$VERSION \
            -f Dockerfile.migrate \
            .

          docker push ${{ secrets.DOCKERHUB_USERNAME }}/crud-migration:$VERSION

          echo "‚úÖ Migration image built and pushed"

      # 10. Ex√©cution des migrations via Cloud SQL Proxy
      - name: Run database migrations
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "üîÑ Running database migrations..."

          # T√©l√©charger Cloud SQL Proxy
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy

          # D√©marrer Cloud SQL Proxy en arri√®re-plan
          ./cloud_sql_proxy -instances=${{ secrets.DB_CONNECTION_NAME }}=tcp:3306 &
          PROXY_PID=$!

          # Attendre que le proxy soit pr√™t
          sleep 10

          # Ex√©cuter les migrations via Docker
          docker run --rm \
            --network host \
            -e DB_HOST=127.0.0.1 \
            -e DB_PORT=3306 \
            -e DB_USER=${{ secrets.DB_USER }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -e DB_NAME=${{ secrets.DB_NAME }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/crud-migration:$VERSION

          # Arr√™ter Cloud SQL Proxy
          kill $PROXY_PID

          echo "‚úÖ Migrations executed successfully"

      # 11. Mise √† jour du fichier Cloud Run avec les valeurs r√©elles
      - name: Update Cloud Run service configuration
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "üìù Updating Cloud Run service configuration..."

          # Remplacer les placeholders dans cloud-run-service.yaml
          sed -i "s|VERSION_TAG|$VERSION|g" cloud-run-service.yaml
          sed -i "s|DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" cloud-run-service.yaml
          sed -i "s|GCP_PROJECT_ID|${{ secrets.GCP_PROJECT_ID }}|g" cloud-run-service.yaml
          sed -i "s|GCP_REGION|${{ secrets.GCP_REGION }}|g" cloud-run-service.yaml
          sed -i "s|DB_INSTANCE_NAME|${{ secrets.DB_INSTANCE_NAME }}|g" cloud-run-service.yaml
          sed -i "s|DB_USER_VALUE|${{ secrets.DB_USER }}|g" cloud-run-service.yaml
          sed -i "s|DB_NAME_VALUE|${{ secrets.DB_NAME }}|g" cloud-run-service.yaml
          sed -i "s|LOKI_URL_VALUE|${{ secrets.LOKI_URL }}|g" cloud-run-service.yaml

          cat cloud-run-service.yaml

          echo "‚úÖ Cloud Run configuration updated"

      # 12. Cr√©er le secret DB password dans Cloud Run (si pas d√©j√† existant)
      - name: Create Cloud Run secrets
        run: |
          echo "üîê Creating/updating Cloud Run secrets..."

          # Cr√©er le secret pour le mot de passe DB (ignore si existe d√©j√†)
          echo -n "${{ secrets.DB_PASSWORD }}" | gcloud secrets create db-password \
            --data-file=- \
            --replication-policy="automatic" 2>/dev/null || \
          echo -n "${{ secrets.DB_PASSWORD }}" | gcloud secrets versions add db-password \
            --data-file=-

          echo "‚úÖ Secrets created/updated"

      # 13. D√©ploiement sur Cloud Run
      - name: Deploy to Cloud Run
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "üöÄ Deploying to Cloud Run..."

          gcloud run services replace cloud-run-service.yaml \
            --region=${{ secrets.GCP_REGION }} \
            --platform=managed

          # Autoriser le trafic public (optionnel)
          gcloud run services add-iam-policy-binding crud-api \
            --region=${{ secrets.GCP_REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker"

          # Obtenir l'URL du service
          SERVICE_URL=$(gcloud run services describe crud-api \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)')

          echo "‚úÖ Deployment successful!"
          echo "üåê Service URL: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT

      # 14. Test de sant√© du service d√©ploy√©
      - name: Health check
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SERVICE_URL=$(gcloud run services describe crud-api \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)')

          echo "üè• Running health check..."

          # Attendre quelques secondes que le service d√©marre
          sleep 15

          # Test du endpoint /health
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL/health)

          if [ "$HEALTH_RESPONSE" -eq 200 ]; then
            echo "‚úÖ Health check passed (HTTP $HEALTH_RESPONSE)"
          else
            echo "‚ùå Health check failed (HTTP $HEALTH_RESPONSE)"
            exit 1
          fi

      # 15. Notification de succ√®s (optionnel - Discord)
      - name: Notify deployment success
        if: success()
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SERVICE_URL=$(gcloud run services describe crud-api \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)')

          echo "üéâ Deployment completed successfully!"
          echo "Version: $VERSION"
          echo "URL: $SERVICE_URL"

          # Si vous avez un webhook Discord, d√©commentez :
          # curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          #   -H "Content-Type: application/json" \
          #   -d "{\"content\":\"üöÄ D√©ploiement r√©ussi de la version $VERSION sur Cloud Run: $SERVICE_URL\"}"

      # 16. Notification d'√©chec
      - name: Notify deployment failure
        if: failure()
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "‚ùå Deployment failed for version $VERSION"

          # Si vous avez un webhook Discord, d√©commentez :
          # curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          #   -H "Content-Type: application/json" \
          #   -d "{\"content\":\"‚ùå √âchec du d√©ploiement de la version $VERSION\"}"
